<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.IO Example</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>Socket.IO Chat</h1>
  <div id="messages"></div>
  <div id="inputContainer">
    <input id="messageInput" type="text" placeholder="Type a message" />
    <button id="sendButton">Send</button>
  </div>
  <script>
    const socket = io();
    
    let currentMessageDiv = null; 
    function appendStreamData(data, role = 'system-message') {
      
      let parsedData;
      try {
        if (typeof data === 'string') {
          parsedData = JSON.parse(data);
        } else {
          parsedData = data;
        }
      } catch (error) {
        console.error('JSON Parse error:', error);
        return;
      }
      const messageContent = parsedData.message.content;

      //流式添加訊息
      if (!currentMessageDiv) {
        currentMessageDiv = document.createElement('p');
        currentMessageDiv.classList.add('message',role);
        document.getElementById('messages').appendChild(currentMessageDiv);
      }
      currentMessageDiv.textContent += messageContent;

      //流式訊息終止
      if (parsedData.done) {
        currentMessageDiv.textContent += "(by ollama)";
        currentMessageDiv = null;
      }

      const messageList = document.getElementById('messages');
      messageList.scrollTop = messageList.scrollHeight;
    }

    socket.on('ollama-stream', (data) => {
      appendStreamData(data, 'system-message');
    });

    function sendMessage(event, message, role) {
      if (message.trim() !== '') {
        socket.emit(event, message);
        const li = document.createElement('p');
        li.textContent = message;
        li.classList.add('message', role);
        document.getElementById('messages').appendChild(li);
        document.getElementById('messageInput').value = '';
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;  // 滾動到最新訊息
      }
    }

    document.getElementById('sendButton').addEventListener('click', () => {
      const message = document.getElementById('messageInput').value;
      sendMessage('message', message, 'user-message');
    });

    document.getElementById('messageInput').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        const message = event.target.value;
        sendMessage('message', message,role='user-message');
      }
    });

  </script>
</body>
</html>
